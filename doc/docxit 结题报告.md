# 			docxit 结题报告

- PB16001749 伊昕宇 
- PB16001750 赵建博
- PB16001724 班泰瑜



## 软件简介

​	docxit是一种docx文件的版本管理软件，运行在Linux系统下，可以对docx文件进行合并比较以及版本管理的功能（类似git），目前已经实现了在本地版本的管理，以后准备继续添加分布式以及网络的功能，实现类似GitHub的版本管理功能。



## 开发背景

​	目前比较流行的版本管理软件git，是一款功能强大的版本管理软件，但是只能实现对文本文件的合并和比较，对于docx这种二进制文件无法实现合并和比较，因此我们想到了开发一款可以对docx文件进行版本管理的软件，docxit。



## 软件原理

​	docxit本地管理的开发主要分为版本管理器的实现和对docxit文档比较功能的实现，前者由PB16001749 伊昕宇 和 PB16001724 班泰瑜 完成，后者由PB16001750 赵建博完成。

- 版本管理的原理是参照git的实现原理：

> ## Git的基本原理
>
> 本质上，Git是一套内容寻址（content-addressable）文件系统，而和我们直接接触的Git界面，只不过是封装在其之上的一个应用层。这个关系颇有点类似于计算机网络中应用层和下属层的关系。在Git中，那些和应用层相关的命令（也就是我们最常用的命令，如git commit、 git push等），我们称之为porcelain命令（瓷器之意，意为成品、高级命令）；而和底层相关的命令（几乎不会在日常中使用，如git hash-object、git update-index等），则称之为plumbing命令（管道之意，是连接git应用界面和git底层实现的一个管道，类似于shell，底层命令）。要了解Git的底层原理，就需要了解Git是如何利用底层命令来实现高层命令的。在此之前，让我们先来看一下Git的目录结构，和各个文件在Git中的作用。
>
> ### Git的目录结构
>
> 在操作系统中，我们的仓库就是一个文件夹。但是为什么这些文件夹就是Git仓库呢？这是因为Git在初始化的时候会生成一个.git的文件夹，而Git进行版本控制所需要的文件，则都放在这个文件夹中。在桌面上新建一个目录，然后利用命令行在该目录下运行git init命令即可完成git仓库的初始化。如果这个时候你看不到.git目录，这是因为你的操作系统自动隐藏了该文件夹，需要在系统设置中设置隐藏文件可见。进入.git目录，便可以看到其中有很多的文件和文件夹，这每一个文件都有各自的作用，下面结合图1来进行说明。
>
> ![img](https://images2017.cnblogs.com/blog/590093/201709/590093-20170910122805351-1396180991.png)
>
> 图1 .git目录结构示意图
>
> 在上图中，第一排的几个文件和文件夹是Git的核心，而第二排的则是一些不需要特别关注的。核心文件包括：config文件、objects文件夹、HEAD文件、index文件以及refs文件夹。下面依次对其进行说明。
>
> - **config文件**：该文件主要记录针对该项目的一些配置信息，例如是否以bare方式初始化、remote的信息等，通过git remote add命令增加的远程分支的信息就保存在这里；
> - **objects文件夹：**该文件夹主要包含git对象。关于什么是git对象，将会在下一节进行详细介绍。Git中的文件和一些操作都会以git对象来保存，git对象分为BLOB、tree和commit三种类型，例如git commit便是git中的commit对象，而各个版本之间是通过**版本树**来组织的，比如当前的HEAD会指向某个commit对象，而该commit对象又会指向几个BLOB对象或者tree对象。objects文件夹中会包含很多的子文件夹，其中Git对象保存在以其sha-1值的前两位为子文件夹、后38位位文件名的文件中；除此以外，Git为了节省存储对象所占用的磁盘空间，会定期对Git对象进行压缩和打包，其中pack文件夹用于存储打包压缩的对象，而info文件夹用于从打包的文件中查找git对象；
> - **HEAD文件：**该文件指明了git branch（即当前分支）的结果，比如当前分支是master，则该文件就会指向master，但是并不是存储一个master字符串，而是分支在refs中的表示，例如ref: refs/heads/master。
> - **index文件：**该文件保存了暂存区域的信息。该文件某种程度就是缓冲区（staging area），内容包括它指向的文件的时间戳、文件名、sha1值等；
> - **Refs文件夹**：该文件夹存储指向数据（分支）的提交对象的指针。其中heads文件夹存储本地每一个分支最近一次commit的sha-1值（也就是commit对象的sha-1值），每个分支一个文件；remotes文件夹则记录你最后一次和每一个远程仓库的通信，Git会把你最后一次推送到这个remote的每个分支的值都记录在这个文件夹中；tag文件夹则是分支的别名，这里不需要对其有过多的了解；
>
> 除此以外，.git目录下还有很多其他的文件和文件夹，这些文件和文件夹会额外支撑一些其他的功能，但是不是Git的核心部分，因此稍作了解即可。hooks主要定义了客户端或服务端钩子脚本，这些脚本主要用于在特定的命令和操作之前或者之后进行特定的处理，比如：当你把本地仓库push到服务器的远程仓库时，可以在服务器仓库的hooks文件夹下定义post_update脚本，在该脚本中可以通过脚本代码将最新的代码部署到服务器的web服务器上，从而将版本控制和代码发布无缝连接起来；description文件仅供GitWeb程序使用，这里不需要过多的关心；logs则记录了本地仓库和远程仓库的每一个分支的提交记录，即所有的commit对象（包括时间、作者等信息）都会被记录在这个文件夹中，因此这个文件夹中的内容是我们查看最频繁的，不管是Git log命令还是tortoiseGit的show log，都需要从该文件夹中获取提交日志；info文件夹保存了一份不希望在.gitignore 文件中管理的忽略模式的全局可执行文件，基本也用不上；COMMIT_EDITMSG文件则记录了最后一次提交时的注释信息。从以上的描述中我们可以发现，.git文件夹中包含了众多功能不一的文件夹和文件，这些文件夹和文件是描述Git仓库所必不可少的信息，不可以随意更改或删除；尤其需要注意的是，.git文件夹随着项目的演进，可能会变得越来越大，因为任何文件的任何一个变动，都需要Git在objects文件夹下将其重新存储为一个新的对象文件，因此如果一个文件非常大，那么你提交几次改动就会造成.git文件夹容量成倍增长。因此，.git文件夹更像是一本书，每一个版本的每一个变动都存储在这本书中，而且这本书还有一个目录，指明了不同的版本的变动内容存储在这本书的哪一页上，这就是Git的最基本的原理。

- 对于docx文档比较采用了GitHub上的docx4j工程包的工具完成。



## 软件功能

​	软件的基本指令类似于git，不同的是针对于docx文件的管理，因此合并的对象是docx文件，指令即功能如下：

​	（这里写一下那个help文本）



## 实现方式

- 对于版本管理的实现：
  - 对于暂存区采用index文件进行保存，add指令会将文件添加到index中，对文件名的分析由一个脚本完成，index文件是文件key值，文件名，文件状态等一系列数据结构的集合，添加时对其进行分析来判断其类型，其中对删除文件操作只能通过add被删除文件名来实现。
  - 对于commit对象，并没有采取git中的树结构进行实现，（过于复杂），而是直接将index文件保存到object目录下，并将其key值作为commit对象中的key值，commit对象还有一些其他的数据结构，如时间，commit message等，通过找到index文件来跟据其中的内容进行版本回溯（reset），容易实现，但缺点是浪费空间。
  - 对于merge操作，是先判断两个分支是否在同一个commit链上，如果是的话，就采用fast forward 方式对其进行简单切换，对于不同分支上的branch，先对index进行合并，有双方修改的调用docxit合并程序处理，会生成双方文件和合并文件，等待冲突解决之后再commit。
  - 其他的功能，如config，tag，log，status的实现比较简单，不再赘述。
- 对于docx文件比较的实现：
  - zjb瞎写写。



## 实际演示

- docxit init 创建一个仓库
- docxit add 添加文件到暂存区
- docxit status 查看暂存区的状态
- docxit commit 提交一个版本
- docxit log 查看版本的提交情况
- docxit reset 进行版本回溯
  -  docxit reset 切换到最近发布的版本
  - docxit reset prev/next 切换到上/下几个版本
- docxit checkout -b branch 产生一个分支
- docxit checkout 进行分支的切换
- docxit merge 
  - fast forward 情况
  - no ff 情况 
- docxit diff 比较docxit文件



## 未来计划

- 添加网络和分布式功能，实现类似GitHub的多人协作功能
- 添加对于文本文件的比较功能，使docxit 在git 的基础上进行拓展
- 优化blob对象占用空间过大问题（对blob文件进行压缩）
- 优化commit对象占用空间过大问题（将index方式改为树方式）
- 进一步实现更多在git中的指令，如checkout + filenam等命令，使功能更加完备